<!doctype html>
<html>
<head>
  <title>Socket.IO chat</title>
  <link rel="stylesheet" type="text/css" href="/public/styles/styles.css">
</head>
<body>
  <!-- <button onclick="disconnect()">Disconnect</button> -->
  <ul id="users"></ul>
  <ul id="messages"></ul> 

  <form id="sendMessage" action="">
    <input id="m" autocomplete="off" onkeypress="inputChanged()"/>
    <button>Send</button>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/public/javascript/jquery.min.js"></script>
  <script src="/public/javascript/User.js"></script>
  <script>
    var socket = io();
    var currentUser;
    var userList = [];

    socket.on('connect', function(){
      currentUser = new User(prompt("What's your name?"));
      socket.emit('addUser', currentUser);

    });

    socket.on('update', function(users){
      userList = users;
      $('#users').empty();
      for (var i = 0 ; i < userList.length; i++){
        var strUser = "";
        if(userList[i].status === "writing"){
          strUser = "<b>"
        }
        strUser += "<li>" + userList[i].name + "</li>"
        
        if(userList[i].status === "writing"){
          strUser += "</b>"
        }

        $('#users').append(strUser);
      }
    });

    socket.on('chat message', function(msg){
      $('#messages').append($('<li>').text(msg));
    });

    $('#sendMessage').submit(function(){
      socket.emit('chat message', currentUser.name, $('#m').val());
      $('#m').val('');
      return false;
    });

    inputChanged = function(){
      var newStatus = "";
      if($('#m').val() !== '') {
        newStatus = "writing";
      } else { 
        newStatus = "inactive";
      }
      if (currentUser.status !== newStatus){
        currentUser.status = newStatus;
        socket.emit('state changed', currentUser);
      }
    }
    disconnect = function(){
      socket.emit('disconnect', currentUser);
    }
  </script>
</body>
</html>